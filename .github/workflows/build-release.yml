name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.1.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: false
        default: 'dev'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install .

      - name: Build with PyInstaller
        run: pyinstaller rpi_logger.spec

      - name: Create ZIP archive
        run: |
          cd dist
          Compress-Archive -Path "Logger" -DestinationPath "Logger-Windows.zip"

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Logger-Windows.zip
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install .

      - name: Build with PyInstaller
        run: pyinstaller rpi_logger.spec

      - name: Create ZIP archive
        run: |
          cd dist
          zip -r "Logger-macOS.zip" "Logger.app"

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Logger-macOS.zip
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libportaudio2 \
            libsndfile1 \
            python3-tk \
            libgl1-mesa-glx \
            libglib2.0-0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install .

      - name: Build with PyInstaller
        run: pyinstaller rpi_logger.spec

      - name: Create tarball
        run: |
          cd dist
          tar -czvf "Logger-Linux-x86_64.tar.gz" "logger"

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Logger-Linux-x86_64.tar.gz
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-appimage:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libportaudio2 \
            libsndfile1 \
            python3-tk \
            libgl1-mesa-glx \
            libglib2.0-0 \
            fuse \
            libfuse2

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install .

      - name: Build with PyInstaller
        run: pyinstaller rpi_logger.spec

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy the built application
          cp -r dist/logger/* AppDir/usr/bin/

          # Copy icon
          cp rpi_logger/core/ui/icon_256.png AppDir/usr/share/icons/hicolor/256x256/apps/logger.png
          cp rpi_logger/core/ui/icon_256.png AppDir/logger.png

          # Create desktop file
          cat > AppDir/logger.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=Logger
          Exec=logger
          Icon=logger
          Categories=Utility;Science;
          Comment=Data logging application for research
          EOF

          cp AppDir/logger.desktop AppDir/usr/share/applications/

          # Create AppRun
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/bin:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/logger" "$@"
          EOF
          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          ARCH=x86_64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir Logger-x86_64.AppImage

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: Logger-x86_64.AppImage
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-raspberry-pi:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU for ARM emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build for Raspberry Pi (ARM64)
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y software-properties-common
            add-apt-repository -y ppa:deadsnakes/ppa
            apt-get update
            apt-get install -y \
              python3.11 \
              python3.11-venv \
              python3.11-dev \
              python3.11-tk \
              libasound2-dev \
              libportaudio2 \
              libsndfile1 \
              libgl1-mesa-glx \
              libglib2.0-0 \
              binutils
          run: |
            python3.11 -m ensurepip --upgrade
            python3.11 -m pip install --upgrade pip
            python3.11 -m pip install pyinstaller
            python3.11 -m pip install .
            python3.11 -m PyInstaller rpi_logger.spec
            cd dist
            tar -czvf "Logger-RaspberryPi-arm64.tar.gz" "logger"

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Logger-RaspberryPi-arm64.tar.gz
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  finalize-release:
    needs: [build-windows, build-macos, build-linux, build-linux-appimage, build-raspberry-pi]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          body: |
            ## Logger ${{ github.ref_name }}

            ### Downloads

            | Platform | File | Notes |
            |----------|------|-------|
            | **Windows** | `Logger-Windows.zip` | Extract and run `Logger.exe` |
            | **macOS** | `Logger-macOS.zip` | Extract and run `Logger.app` |
            | **Linux (x86_64)** | `Logger-Linux-x86_64.tar.gz` | Extract and run `./logger` |
            | **Linux (AppImage)** | `Logger-x86_64.AppImage` | Make executable and run directly |
            | **Raspberry Pi** | `Logger-RaspberryPi-arm64.tar.gz` | Extract and run `./logger` |

            ### Installation

            **No installation required!** Just download, extract (if needed), and run.

            #### macOS Note
            On first run, you may need to right-click and select "Open" to bypass Gatekeeper,
            or go to System Preferences > Security & Privacy to allow the app.

            #### Linux AppImage
            ```bash
            chmod +x Logger-x86_64.AppImage
            ./Logger-x86_64.AppImage
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
