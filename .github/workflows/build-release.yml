name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.1.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: false
        default: 'dev'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install .

      - name: Build with PyInstaller
        run: pyinstaller rpi_logger.spec

      - name: Create ZIP archive
        run: |
          cd dist
          Compress-Archive -Path "RPi Logger" -DestinationPath "RPi-Logger-Windows.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: RPi-Logger-Windows
          path: dist/RPi-Logger-Windows.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install .

      - name: Build with PyInstaller
        run: pyinstaller rpi_logger.spec

      - name: Create ZIP archive
        run: |
          cd dist
          zip -r "RPi-Logger-macOS.zip" "RPi Logger.app"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: RPi-Logger-macOS
          path: dist/RPi-Logger-macOS.zip

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libportaudio2 \
            libsndfile1 \
            python3-tk \
            libgl1-mesa-glx \
            libglib2.0-0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install .

      - name: Build with PyInstaller
        run: pyinstaller rpi_logger.spec

      - name: Create tarball
        run: |
          cd dist
          tar -czvf "RPi-Logger-Linux-x86_64.tar.gz" "rpi-logger"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: RPi-Logger-Linux-x86_64
          path: dist/RPi-Logger-Linux-x86_64.tar.gz

  build-linux-appimage:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libportaudio2 \
            libsndfile1 \
            python3-tk \
            libgl1-mesa-glx \
            libglib2.0-0 \
            fuse \
            libfuse2

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install .

      - name: Build with PyInstaller
        run: pyinstaller rpi_logger.spec

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy the built application
          cp -r dist/rpi-logger/* AppDir/usr/bin/

          # Copy icon (use logo or create placeholder)
          if [ -f "rpi_logger/core/ui/logo_100.png" ]; then
            cp rpi_logger/core/ui/logo_100.png AppDir/usr/share/icons/hicolor/256x256/apps/rpi-logger.png
            cp rpi_logger/core/ui/logo_100.png AppDir/rpi-logger.png
          else
            # Create a simple placeholder icon
            convert -size 256x256 xc:navy -fill white -gravity center -pointsize 24 -annotate 0 "RPi\nLogger" AppDir/rpi-logger.png || true
          fi

          # Create desktop file
          cat > AppDir/rpi-logger.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=RPi Logger
          Exec=rpi-logger
          Icon=rpi-logger
          Categories=Utility;Science;
          Comment=Cross-platform data logger with Raspberry Pi camera support
          EOF

          cp AppDir/rpi-logger.desktop AppDir/usr/share/applications/

          # Create AppRun
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/bin:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/rpi-logger" "$@"
          EOF
          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          ARCH=x86_64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir RPi-Logger-x86_64.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: RPi-Logger-Linux-AppImage
          path: RPi-Logger-x86_64.AppImage

  build-raspberry-pi:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU for ARM emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build for Raspberry Pi (ARM64)
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y software-properties-common
            add-apt-repository -y ppa:deadsnakes/ppa
            apt-get update
            apt-get install -y \
              python3.11 \
              python3.11-venv \
              python3.11-dev \
              python3.11-tk \
              libasound2-dev \
              libportaudio2 \
              libsndfile1 \
              libgl1-mesa-glx \
              libglib2.0-0
          run: |
            python3.11 -m ensurepip --upgrade
            python3.11 -m pip install --upgrade pip
            python3.11 -m pip install pyinstaller
            python3.11 -m pip install .
            python3.11 -m PyInstaller rpi_logger.spec
            cd dist
            tar -czvf "RPi-Logger-RaspberryPi-arm64.tar.gz" "rpi-logger"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: RPi-Logger-RaspberryPi-arm64
          path: dist/RPi-Logger-RaspberryPi-arm64.tar.gz

  create-release:
    needs: [build-windows, build-macos, build-linux, build-linux-appimage, build-raspberry-pi]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -la artifacts/*/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            artifacts/RPi-Logger-Windows/RPi-Logger-Windows.zip
            artifacts/RPi-Logger-macOS/RPi-Logger-macOS.zip
            artifacts/RPi-Logger-Linux-x86_64/RPi-Logger-Linux-x86_64.tar.gz
            artifacts/RPi-Logger-Linux-AppImage/RPi-Logger-x86_64.AppImage
            artifacts/RPi-Logger-RaspberryPi-arm64/RPi-Logger-RaspberryPi-arm64.tar.gz
          body: |
            ## RPi Logger ${{ github.ref_name }}

            ### Downloads

            | Platform | File | Notes |
            |----------|------|-------|
            | **Windows** | `RPi-Logger-Windows.zip` | Extract and run `RPi Logger.exe` |
            | **macOS** | `RPi-Logger-macOS.zip` | Extract and run `RPi Logger.app` |
            | **Linux (x86_64)** | `RPi-Logger-Linux-x86_64.tar.gz` | Extract and run `./rpi-logger` |
            | **Linux (AppImage)** | `RPi-Logger-x86_64.AppImage` | Make executable and run directly |
            | **Raspberry Pi** | `RPi-Logger-RaspberryPi-arm64.tar.gz` | Extract and run `./rpi-logger` |

            ### Installation

            **No installation required!** Just download, extract (if needed), and run.

            #### macOS Note
            On first run, you may need to right-click and select "Open" to bypass Gatekeeper,
            or go to System Preferences > Security & Privacy to allow the app.

            #### Linux AppImage
            ```bash
            chmod +x RPi-Logger-x86_64.AppImage
            ./RPi-Logger-x86_64.AppImage
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
